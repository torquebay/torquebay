<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
  const supabaseUrl = 'https://jyejmnszfbkyeacbhbez.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5ZWptbnN6ZmJreWVhY2JoYmV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyNDc1NzcsImV4cCI6MjA2NzgyMzU3N30.72yNaR3DJd30hiMZvJwN_KCOBgdBjhE1kGBAuq4ZvSQ';

  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  const listingsEl = document.getElementById('listings');
  const uploadSection = document.getElementById('uploadSection');
  const userStatus = document.getElementById('userStatus');
  const logoutBtn = document.getElementById('logoutBtn');

  async function fetchListings() {
    const { data: listings, error } = await supabase
      .from('listings')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      listingsEl.innerHTML = `<p>Error loading listings: ${error.message}</p>`;
      return;
    }

    listingsEl.innerHTML = '';
    listings.forEach(listing => {
      const div = document.createElement('div');
      div.className = 'listing';
      div.innerHTML = `
        <h3>${listing.title}</h3>
        <img src="${listing.image_url}" alt="car" />
        <p>${listing.description}</p>
        <p>Price: Â£${listing.price}</p>
        <p>Buy Now: Â£${listing.buy_now_price}</p>
        <button onclick="buyNow('${listing.id}')">Buy It Now</button>
      `;
      listingsEl.appendChild(div);
    });
  }

  async function buyNow(id) {
    const session = supabase.auth.getSession();
    const user = (await session).data.session?.user;
    if (!user) {
      alert('Please login first!');
      return location.href = '/login.html';
    }

    const res = await fetch('/api/buy/' + id, {
      method: 'POST',
      headers: { Authorization: 'Bearer ' + (await session).data.session.access_token }
    });
    const data = await res.json();
    alert(data.message);
  }

  document.getElementById('listingForm').onsubmit = async (e) => {
    e.preventDefault();
    const session = await supabase.auth.getSession();
    const user = session.data.session?.user;
    if (!user) {
      alert('Please login first!');
      return location.href = '/login.html';
    }

    const form = e.target;
    const formData = new FormData(form);

    const res = await fetch('/api/listings', {
      method: 'POST',
      headers: { Authorization: 'Bearer ' + session.data.session.access_token },
      body: formData
    });
    const data = await res.json();
    if (data.error) return alert(data.error);
    alert('Listing uploaded successfully!');
    form.reset();
    fetchListings();
  };

  logoutBtn.onclick = async () => {
    await supabase.auth.signOut();
    alert('Logged out!');
    location.reload();
  };

  async function checkUser() {
    const { data: { user } } = await supabase.auth.getUser();

    if (user) {
      userStatus.innerHTML = `<p>Welcome back, <strong style="color:red">${user.email}</strong>! ðŸ‘‹</p>`;
      uploadSection.style.display = 'block';
      logoutBtn.style.display = 'inline-block';
    } else {
      userStatus.innerHTML = `<p><a href="/login.html" style="color:red">Login</a> or <a href="/register.html" style="color:red">Register</a> to upload listings and buy cars.</p>`;
      uploadSection.style.display = 'none';
      logoutBtn.style.display = 'none';
    }
  }

  // Run on page load
  checkUser();
  fetchListings();

  // Listen for login/logout events
  supabase.auth.onAuthStateChange((_event, session) => {
    checkUser();
  });
</script>
